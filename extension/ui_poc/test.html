<html>
    <head>
        <link href='https://fonts.googleapis.com/css?family=Pragati Narrow' rel='stylesheet'>
        <!-- <style>
            .no-outline {
                border-top-style: hidden;
                border-right-style: hidden;
                border-left-style: hidden;
                border-bottom-style: hidden;
            }
            
            .no-outline:focus {
                outline: none;
            }
            .loader,
            .loader:after {
                border-radius: 50%;
                width: 10em;
                height: 10em;
            }
            .loader {
                margin: 1px auto;
                font-size: 1px;
                position: relative;
                text-indent: -9999em;
                border-top: 1.1em solid rgba(140,130,130, 0.2);
                border-right: 1.1em solid rgba(140,130,130, 0.2);
                border-bottom: 1.1em solid rgba(140,130,130, 0.2);
                border-left: 1.1em solid #8c8282;
                -webkit-transform: translateZ(0);
                -ms-transform: translateZ(0);
                transform: translateZ(0);
                -webkit-animation: load8 1.1s infinite linear;
                animation: load8 1.1s infinite linear;
            }
            @-webkit-keyframes load8 {
                0% {
                    -webkit-transform: rotate(0deg);
                    transform: rotate(0deg);
                }
                100% {
                    -webkit-transform: rotate(360deg);
                    transform: rotate(360deg);
                }
            }
            @keyframes load8 {
                0% {
                    -webkit-transform: rotate(0deg);
                    transform: rotate(0deg);
                }
                100% {
                    -webkit-transform: rotate(360deg);
                    transform: rotate(360deg);
                }
            }
            /* Hide scrollbar for Chrome, Safari and Opera */
            .hideScrollbar::-webkit-scrollbar {
                display: none;
            }

            /* Hide scrollbar for IE, Edge and Firefox */
            .hideScrollbar {
                -ms-overflow-style: none;  /* IE and Edge */
                scrollbar-width: none;  /* Firefox */
            }

            .tooltipBorder .jBox-container,
            .tooltipBorder .jBox-pointer:after {
                border: 2px solid #234C87;
            }

            .box-shadow {
                box-shadow: 0px 6px 10px rgba(0, 0, 0, 0.14), 0px 1px 18px rgba(0, 0, 0, 0.12), 0px 3px 5px rgba(0, 0, 0, 0.2);
            }
        </style> -->

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/StephanWagner/jBox@v1.3.2/dist/jBox.all.min.js"></script>
        <link href="https://cdn.jsdelivr.net/gh/StephanWagner/jBox@v1.3.2/dist/jBox.all.min.css" rel="stylesheet">

        <script>
            var cssWasAdded = false;
            const hostnameToPattern = new Map();
            hostnameToPattern.set('github.com', '![$name]($url)');

            let resultsCache = new Map()
            let macroNameToUrl = new Map()
            macroNameToUrl.set('nonono', 'https://www.image.com/nonono.gif');
            const tooltipsCache = new Map();
            const targetIdToTarget = new Map();
            let batchFetchCounter = 0

            getElement = function(targetId, id) {
                return $('#' + targetId + '_' + id)[0]
            }

            showSearchSpinner = function(targetId) {
                getElement(targetId, 'searchSpinner').style.display = 'inline';
                getElement(targetId, 'searchIcon').style.display = 'none';
            }

            hideSearchSpinner = function(targetId) {
                getElement(targetId, 'searchSpinner').style.display = 'none';
                getElement(targetId, 'searchIcon').style.display = 'inline';
            }

            initSearchInput = function (targetId) {
                const searchInput = getElement(targetId, 'macroSearchInput');
                searchInput.addEventListener('input', updateValue);

                let inputTimerId = null;

                function updateValue(e) {
                    if (inputTimerId != null) {
                        clearTimeout(inputTimerId);
                        inputTimerId = null;
                    }

                    if (resultsCache.has(searchInput.value)) {
                        response = resultsCache.get(searchInput.value)
                        processResponse(targetId, response, true, null)
                        hideSearchSpinner(targetId)
                        return
                    }

                    showSearchSpinner(targetId)

                    inputTimerId = setTimeout(
                        () => {
                            fetchNextPage(
                                targetId,
                                () => {
                                    hideSearchSpinner(targetId)
                                    inputTimerId = null;
                                }
                            )                            
                        },
                        500,
                    );
                }
            }

            getInjectedMacro = function(name, url) {
                // const pattern = hostnameToPattern.get(location.hostname);
                const pattern = '![$name]($url)';
                return pattern.replace('$name', name).replace('$url', url);
            }

            selectMacro = function(targetId, macro) {
                target = targetIdToTarget.get(targetId);
                const selectionIndex = target.selectionStart - 1;
                const macroToInject = getInjectedMacro(macro["name"], macro["url"]);
                const newValue = target.value.slice(0, target.selectionStart - 1) + macroToInject + target.value.slice(target.selectionStart);
                target.value = newValue;
                tooltipsCache.get(target)['tooltip'].close();
                target.focus();
                target.selectionStart = selectionIndex + macroToInject.length;
                target.selectionEnd = target.selectionStart;
            }

            processResponse = function (targetId, response, isFirstPage, searchText) {
                leftMacroDiv = getElement(targetId, 'leftMacros');
                rightMacroDiv = getElement(targetId, 'rightMacros');

                if (isFirstPage) {
                    leftMacroDiv.innerHTML = '';
                    rightMacroDiv.innerHTML = '';                            
                }

                getElement(targetId, 'moreResultsSpinner').style.display = response['has_more'] ? 'inline' : 'none';

                let divs = [leftMacroDiv, rightMacroDiv];
                const results = response['data'];
                for (var i = 0; i < results.length; i++) {
                    const result = results[i];

                    if (searchText !== null) {
                        resultsCache.get(searchText)['data'].push(result)
                    }
                    macroNameToUrl.set(result['name'], result['url']);

                    const image = document.createElement('img');
                    image.style.width = '100%';
                    image.style.marginTop = '5px';
                    image.style.marginBottom = '5px';
                    image.style.borderRadius = '5px';
                    image.src = result['url'];
                    image.title = result['name'];
                    image.onclick = function() {selectMacro(targetId, result);};
                    divs[i % 2].appendChild(image);
                }
            }

            fetchNextPage = function(targetId, onFinishCallback) {
                batchFetchCounter++

                const searchText = getElement(targetId, 'macroSearchInput').value

                const curBatchFetch = batchFetchCounter
                const xhttp = new XMLHttpRequest();

                const pageToFetch = resultsCache.has(searchText) ? resultsCache.get(searchText)['next_page'] : 0

                xhttp.onreadystatechange = function() {
                    if (this.readyState !== 4 || this.status !== 200) {
                        return
                    }

                    if (curBatchFetch != batchFetchCounter) {
                        return
                    }

                    if (!resultsCache.has(searchText)) {
                        resultsCache.set(searchText, {'data': [], 'has_more': false, 'next_page': 0})
                    }

                    response = JSON.parse(this.responseText);
                    processResponse(targetId, response, pageToFetch == 0, searchText)

                    resultsCache.get(searchText)['has_more'] = response['has_more']
                    resultsCache.get(searchText)['next_page'] = pageToFetch + 1

                    if (onFinishCallback) {
                        onFinishCallback()
                    }
                };

                const url = new URL('https://us-central1-github-macros.cloudfunctions.net/query/')

                if (searchText !== '') {
                    url.searchParams.append('type', 'search')
                    url.searchParams.append('text', searchText)
                    url.searchParams.append('page', pageToFetch)
                } else {
                    url.searchParams.append('type', 'suggestion')
                    url.searchParams.append('page', pageToFetch)
                }
                xhttp.open("GET", url.toString(), true);
                xhttp.send();
            }

            createTooltip = function(targetId, target) {
                idPrefix = targetId + '_';
                return new jBox(
                    'Tooltip',
                    {
                        // attach: '#'+target_id,
                        target: target,
                        //theme: 'TooltipBorder',
                        addClass: 'tooltipBorder',
                        // trigger: 'click', //TODO remove that
                        width: '300px',
                        height: '400px',
                        // adjustTracker: true,
                        closeOnClick: 'body',
                        closeOnEsc: true,
                        // animation: 'move',
                        position: {
                            x: 'left',
                            y: 'top'
                        },
                        outside: 'y',
                        pointer: 'left:20',
                        offset: {
                            x: 25
                        },
                        onCreated: function () {
                            initNewTooltip(targetId);
                        },
                        onOpen: function () {
                            if (resultsCache.has('')) {
                                response = resultsCache.get('');
                                processResponse(targetId, response, true, null);
                            } else {
                                fetchNextPage(targetId);
                            }
                        },
                        onOpenComplete: function () {
                            getElement(targetId, 'macroSearchInput').focus();
                        },
                        onClose: function () {
                            handleCloseTooltip(targetId);
                        },
                        content:`
                        <div style="width: 100%; height: 100%; position: absolute; top: 0px; left: 0px; right: 0px; bottom: 0px; overflow: hidden">
                            <div style="display: flex; flex-direction: row; height: 55px;">
                                <div style="display: flex; flex-direction: row; width: 100%; height: auto; margin: 10px; border-width: 1px; border-style: solid none solid solid; border-color: #234C87; border-radius: 18px; overflow: auto">
                                    <div style="display: flex; margin-left: 10px; width: 15px; height: 15px; justify-content: center; align-items: center; height: 100%; ">
                                        <img id="${idPrefix}searchIcon" style="width: 15px; height: 15px;" src="mglass-4x.png" />
                                        <div id="${idPrefix}searchSpinner" style="display: none;" class="gh-macros-loader"></div>
                                    </div>
                                    <div style="display: flex; justify-content: center; align-items: center; height: 100%; flex-grow: 1;">
                                        <input class="gh-macros-no-outline" type="text" id="${idPrefix}macroSearchInput" style="width: 100%; padding-left: 12px;">
                                    </div>
                                    <div style="display: flex; justify-content: center; align-items: center; height: 100%; width: 70px; background-color: #234C87; border-radius: 10px 0 0 10px;">
                                        <text style="font-family: 'Pragati Narrow'; font-weight: 700; color: white; user-select: none;">Search</text>
                                    </div>
                                </div>
                            </div>
                            <div id="${idPrefix}macrosSection" class="gh-macros-hideScrollbar" style="width: 100%; height: 340px; overflow: auto; display: flex; flex-direction: column;">
                                <div style="width: 100%; display: flex; flex-direction: row; flex:1; padding-top: 5px">
                                    <div id="${idPrefix}leftMacros" style="width: 55%; margin-left: 10px; margin-right: 5px;">
                                    </div>
                                    <div id="${idPrefix}rightMacros" style="width: 45%; margin-left: 5px; margin-right: 10px;">
                                    </div>
                                </div>
                                <div id="${idPrefix}moreResultsSpinner" style="width: 100%; height: 40px;flex-shrink: 0; align-items: center; display: flex;">
                                    <div class="gh-macros-loader" style="font-size: 2px;"></div>
                                </div>
                            </div>
                            <div class="gh-macros-box-shadow box-hover" style="z-index: 100; display: flex; justify-content: center; align-items: center; position: absolute; right: 16px; bottom: 16px; width: 30px; height: 30px; background-color: #234C87; border-radius: 15px;" onmouseover="this.style.background='#526683';" onmouseout="this.style.background='#234C87';">
                                <img style="width: 7px; height: 7px" src="plus-4x.png" />
                            </div>    
                        </div>
                        `,
                    },
                )
            }

            makeid = function(length) {
                var result           = '';
                const characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                const charactersLength = characters.length;
                for ( var i = 0; i < length; i++ ) {
                    result += characters.charAt(Math.floor(Math.random() * charactersLength));
                }
                return result;
            }

            createTooltipMeta = function(target) {
                const targetId = makeid(10)
                const tooltip = createTooltip(targetId, target);

                const newTooltipMeta = {
                    'targetId': targetId,
                    'tooltip': tooltip,
                    'wasInit': false,
                };

                return newTooltipMeta
            }

            handleCloseTooltip = function(targetId) {
                getElement(targetId, 'macroSearchInput').value = '';
                hideSearchSpinner(targetId);
                batchFetchCounter++;
                getElement(targetId, 'leftMacros').innerHTML = '';
                getElement(targetId, 'rightMacros').innerHTML = '';
            }

            initNewTooltip = function(targetId) {
                initSearchInput(targetId);

                macrosSection = getElement(targetId, 'macrosSection');
                // init scroll of the macros section
                macrosSection.addEventListener(
                    "onwheel" in document ? "wheel" : "mousewheel",
                    e => {
                        e.wheel = e.deltaY ? -e.deltaY : e.wheelDelta/40;
                        macrosSection.scrollTop -= e.wheel;
                    },
                );
            }

            loadCss = function() {
                if (cssWasAdded) {
                    return
                }
                cssWasAdded = true;

                styleText = `
                .gh-macros-no-outline {
                    border-top-style: hidden;
                    border-right-style: hidden;
                    border-left-style: hidden;
                    border-bottom-style: hidden;
                }
                
                .gh-macros-no-outline:focus {
                    outline: none;
                }
                .gh-macros-loader,
                .gh-macros-loader:after {
                    border-radius: 50%;
                    width: 10em;
                    height: 10em;
                }
                .gh-macros-loader {
                    margin: 1px auto;
                    font-size: 1px;
                    position: relative;
                    text-indent: -9999em;
                    border-top: 1.1em solid rgba(140,130,130, 0.2);
                    border-right: 1.1em solid rgba(140,130,130, 0.2);
                    border-bottom: 1.1em solid rgba(140,130,130, 0.2);
                    border-left: 1.1em solid #8c8282;
                    -webkit-transform: translateZ(0);
                    -ms-transform: translateZ(0);
                    transform: translateZ(0);
                    -webkit-animation: load8 1.1s infinite linear;
                    animation: gh-macros-load8 1.1s infinite linear;
                }
                @keyframes gh-macros-load8 {
                    0% {
                        -webkit-transform: rotate(0deg);
                        transform: rotate(0deg);
                    }
                    100% {
                        -webkit-transform: rotate(360deg);
                        transform: rotate(360deg);
                    }
                }
                /* Hide scrollbar for Chrome, Safari and Opera */
                .gh-macros-hideScrollbar::-webkit-scrollbar {
                    display: none;
                }

                /* Hide scrollbar for IE, Edge and Firefox */
                .gh-macros-hideScrollbar {
                    -ms-overflow-style: none;  /* IE and Edge */
                    scrollbar-width: none;  /* Firefox */
                }

                .tooltipBorder .jBox-container,
                .tooltipBorder .jBox-pointer:after {
                    border: 2px solid #234C87;
                }

                .gh-macros-box-shadow {
                    box-shadow: 0px 6px 10px rgba(0, 0, 0, 0.14), 0px 1px 18px rgba(0, 0, 0, 0.12), 0px 3px 5px rgba(0, 0, 0, 0.2);
                }
                `

                const style = document.createElement('style');
                style.setAttribute('type', 'text/css');
                style.appendChild(document.createTextNode(styleText))
                document.head.appendChild(style)
            }

            openTooltip = function(target) {
                var tooltipMeta;
                if (tooltipsCache.has(target)) {
                    tooltipMeta = tooltipsCache.get(target);
                } else {
                    tooltipMeta = createTooltipMeta(target);
                    tooltipsCache.set(target, tooltipMeta);
                    targetIdToTarget.set(tooltipMeta['targetId'], target);
                }
                loadCss();
                tooltipMeta["tooltip"].open()
            }    

            requestMacroOnPattern = function(target) {
                value = target.value.slice(0, target.selectionStart - 1);
                var index = value.length - 1;
                while (index >= 0 && value[index] != ' ' && value[index] != '$') {
                    index--;
                }

                if (value[index] !== '$') {
                    return;
                }

                const name =  value.slice(index+1, target.selectionStart)

                if (macroNameToUrl.has(name)) {
                    injectMacroPattern(target, name, macroNameToUrl.get(name));
                    return;
                }
            }

            injectMacroPattern = function(target, name, url) {
                var value = target.value; 
                var selectionStart = target.selectionStart;

                const pattern = '$' + name + '$';
                const injectedMacro = getInjectedMacro(name, url)
                
                var index = value.indexOf(pattern);
                while (index !== -1) {
                    if (index < selectionStart) {
                        selectionStart -= pattern.length
                        selectionStart += injectedMacro.length
                    }
                    
                    value = value.replace(pattern, injectedMacro);
                    var index = value.indexOf(pattern);
                }
                
                target.value = value
                target.selectionStart = selectionStart
                target.selectionEnd = selectionStart
            }

            initKeyboardListeners = function() {
                document.onkeydown = function(ev) {
                    // if (hostnameToPattern.has(location.hostname)) {
                    //     return
                    // }

                    activeElement = document.activeElement
                    // TODO needs to be configured whether we wanna do it also
                    // for regular input + exlusion of our input fields
                    if (!(activeElement instanceof HTMLTextAreaElement)) {
                        return
                    }

                    const text = activeElement.value
                    const pos = activeElement.selectionStart

                    // we open only for ! that is the beginning of a new word
                    if (ev.key === '!' && (pos === 0 || text[pos-1] === ' ') && (pos === text.length || text[pos] === ' ')) {
                        setTimeout(() => openTooltip(activeElement), 0)
                    }

                    if (ev.key === '$') {
                        setTimeout(() => requestMacroOnPattern(activeElement), 0)
                    }
                };
            }

            window.onload = function() {
                initKeyboardListeners()
            }
        </script>
    </head>
    <body>
        <div id="login"></div>
        <div style="height: 2000px; width: 200px; background-color: #526683"></div>
        <textarea rows="4" cols="50"></textarea>
        <div style="height: 2000px; width: 200px; background-color: #999"></div>
        <textarea rows="4" cols="50"></textarea>
        <div style="height: 200px; width: 200px; background-color: rgb(26, 182, 12); overflow-y: scroll;">
            <div style="height: 150px; width: 200px; background-color: rgb(134, 16, 99)"></div>
            <div style="height: 150px; width: 200px; background-color: rgb(252, 6, 178)"></div>
        </div>
    </body>
</html>